{% extends 'main/base.html' %}
{% load leaflet_tags %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}
{% block head %}
{{ form.media.css }}
{% leaflet_js %}
{% leaflet_css %}

<!-- https://docs.mapbox.com/mapbox-gl-js/example/mapbox-gl-draw/ -->
<!--  Mapbox GL JS-->
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<!--  GeoCoder -->
<meta name='robots' content='noindex, nofollow'>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.css' type='text/css' />
<!--  Polygon Draw-->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
<!--  Turf JS for calculating the area. -->
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
<!-- Shepherd.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@lHOatest/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/js/shepherd.min.js"></script>

<!--  Mapbox Draw -->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css' />
<link rel="stylesheet" href="{% static 'main/css/style.css' %}">
<script type="text/javascript">
    sessionStorage.setItem("allChecks", "pass");
    var mapbox_user_name = "{{mapbox_user_name}}";
    var drive_id = "{{drive_id}}";
    var organization_id = "{{organization_id}}";
    var drive_name = "{{drive_name}}";
    var organization_name = "{{organization_name}}";
    var state = "{{state}}";
    var address_required = "{{address_required}}";
    var language = "{{LANGUAGE_CODE}}"
    mixpanel.track("Entry Page Loaded",
    {
     "drive_id": drive_id,
     "drive_name": drive_name,
     "organization_id": organization_id,
     "organization_name": organization_name,
    }
    );
</script>
<script src='https://www.google.com/recaptcha/api.js' async defer></script>
<style data="slider-data" type="text/css"></style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row row-content">
        <div class="col-sm-2">
        </div>
        <div class="col-sm-8">
            <!-- START FORM BODY -->
            <div class="row">
                <!-- Entry Form -->
                <form id="entryForm" method="post" onSubmit="return validateRecaptcha();">
                    {% comment %} <div class="row">
                        <div class="col-sm-7 my-auto pl-5">
                            <h1 class="font-weight-light">
                                {% trans "Map your community" %}
                            </h1>

                            <p class="">
                                {% blocktrans %}
                                Make your voice heard! Fill out the form below and draw a map to add your community to Representable.org.
                                <br>
                                Follow the instructions in each section to get started.
                                {% endblocktrans %}
                            </p>
                            {% csrf_token %}
                        </div>
                        <div class="col-5 d-none d-sm-block">
                          <div id="mapping-image-div" class="m-auto py-4 w-75 h-100">
                            <object type="image/svg+xml" class="w-75 mx-auto d-block h-100" data="{% static 'img/mapping.svg' %}" alt="image of someone drawing a community map"></object>
                          </div>
                        </div>
                    </div>
                    <div class="row">
                      <!-- {# Include the non-field error fields #} -->
                      {% if comm_form.non_field_errors %}
                      <div class="non-field-errors form-error">
                          {% for err in comm_form.non_field_errors %}
                          <p class="form-error">{{ err }}</p>
                          {% endfor %}
                      </div>
                      {% endif %}
                      {% if comm_form.errors %}
                      <div id="django_form_errors">
                      </div>
                      {% endif %}
                      <div id="form_error" class="alert alert-danger alert-dismissible fade show form-error d-none" role="alert">
                          {% blocktrans %}There was an error in submitting your community. Please check over and
                          ensure that you have filled out all required fields. {% endblocktrans %}
                          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                          </button>
                      </div>
                    </div> {% endcomment %}
                    
                    {% include './entry_address.html' %}

                    {% comment %} {% include './entry_survey.html' %} {% endcomment %}

                    {% comment %} {% include './entry_map.html' %} {% endcomment %}

                    {% comment %} {% include './entry_privacy.html' %} {% endcomment %}

                    {% comment %} <div id="dropuphelp2" class="btn-floating btn-group shadow-lg dropup">
                        <button type="button" class="btn fixed-action-btn btn-secondary shadow-lg dropdown-toggle" id="dropuphelp" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-question-circle" aria-hidden="true"></i><span class="d-none d-sm-inline"> {% trans "Help" %}</span>
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropuphelp">
                        <a class="dropdown-item" href="https://docs.google.com/forms/d/e/1FAIpQLSfeyoZ87pS67iTh2c3t5031XqoNFNAdwF6Pt1NUns_z_Myxaw/viewform"> {% trans "Report Error/Send Feedback" %}</a>
                        </div>
                    </div>
                    <div class="btn-floating btn-group shadow-lg">
                        <button type="button" class="btn fixed-action-btn btn-secondary shadow-lg" id="loading-entry">
                        <div class="loader loader-small text-center"></div><span class="d-none d-sm-inline"> {% trans "Saving Community..." %}</span>
                        </button>
                    </div>
                    <div class='row row-equal-cols'>
                        <div class='col-lg text-center m-2'>
                            <div style="display: inline-block;">
                                <button id="save" form="entryForm" type="submit" class="btn btn-lg btn-primary" value="Submit">{% trans "Save Community" %}</button>
                            </div>
                        </div>
                    </div> {% endcomment %}
                </form>
            </div>
        </div>
        <div class="col-sm-2">
        </div>
        <div class="row">
            <div id="video_popup" class="card shadow col-sm-4 col-md-4 col-lg-4 d-none">
                <div id="video_popup_body" class="card-body">
                    <h5 class="card-title">
                        Video Tutorial <button type="button" class="close" onclick="closePopup()">&times;</button>
                    </h5>
                    <div class="embed-responsive embed-responsive-16by9">
                        <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/aQ4PhsxYGUE" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% endblock %}
    {% block script %}
    {{ form.media.js }}
    <script type="text/javascript">
        mapboxgl.accessToken = "{{ mapbox_key }}";
    </script>
    <script type="text/javascript" src="{% static 'main/js/components/keys.js' %}"></script>
    <script type="text/javascript" src="{% static 'main/js/components/states.js' %}"></script>
    <script type="text/javascript" src="{% static 'main/js/wicket.js' %}"></script>
    <script type="text/javascript" src="{% static 'main/js/geo.js' %}"></script>
    <script type="text/javascript">
        // Entry page
        mixpanel.track_links(".dropdown-user-guide", "User Guide Link Pressed (Entry Help Dropdown)");
        mixpanel.track_links(".dropdown-send-feedback", "Send Feedback Link Pressed (Entry Help Dropdown)");

        document.getElementById("dropuphelp").addEventListener("click",
            function(){
                mixpanel.track("Dropup Help Button Pressed (Entry Page)");
            }
        );

        mixpanel.track_forms("#entryForm", "Entry Form Submitted", {
            "drive_id": drive_id,
            "drive_name": drive_name,
            "organization_id": organization_id,
            "organization_name": organization_name,
        });

    </script>
    <script type="text/javascript">
    function validateRecaptcha() {
        var response = grecaptcha.getResponse();
        if (response.length === 0 && "{{ check_captcha }}" === "True") {
            let newAlert = document.createElement("div");
            newAlert.innerHTML =
              '<div id="' +
              "captcha_submit" +
              '" class="alert alert-danger alert-dismissible fade show map-alert" role="alert">\
            ' +
              "You must complete the captcha to submit this map" +
              '\
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">\
            <span aria-hidden="true">&times;</span>\
            </button>\
            </div>';
            document.getElementById("captcha").appendChild(newAlert);
            return false;
        } else {
            return formValidation();
        }
    }
    </script>
    <!-- Turf to get the bounding box. -->
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    {% endblock %}
