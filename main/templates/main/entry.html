{% extends 'main/base.html' %}
{% load leaflet_tags %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}
{% block head %}
{{ form.media.css }}
{% leaflet_js %}
{% leaflet_css %}

<!-- https://docs.mapbox.com/mapbox-gl-js/example/mapbox-gl-draw/ -->
<!--  Mapbox GL JS-->
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<!--  GeoCoder -->
<meta name='robots' content='noindex, nofollow'>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.css' type='text/css' />
<!--  Polygon Draw-->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
<!--  Turf JS for calculating the area. -->
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
<!-- Shepherd.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@lHOatest/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/js/shepherd.min.js"></script>

<!--  Mapbox Draw -->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css' />
<link rel="stylesheet" href="{% static 'main/css/style.css' %}">
<script type="text/javascript">
    sessionStorage.setItem("allChecks", "pass");
    var mapbox_user_name = "{{mapbox_user_name}}";
    var drive_id = "{{drive_id}}";
    var organization_id = "{{organization_id}}";
    var drive_name = "{{drive_name}}";
    var organization_name = "{{organization_name}}";
    var state = "{{state}}";
    var address_required = "{{address_required}}";
    var language = "{{LANGUAGE_CODE}}"
    mixpanel.track("Entry Page Loaded",
    {
     "drive_id": drive_id,
     "drive_name": drive_name,
     "organization_id": organization_id,
     "organization_name": organization_name,
    }
    );
</script>
<script src='https://www.google.com/recaptcha/api.js' async defer></script>
<style data="slider-data" type="text/css"></style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row row-content">
        <div class="col-sm-2">
        </div>
        <div class="col-sm-8">
            <!-- START FORM BODY -->
            <div class="row mt-3">
                <!-- Entry Form -->
                <form id="entryForm" method="post" onSubmit="return validateRecaptcha();">
                    {% csrf_token %}
                    {% comment %} <div class="row">
                        <div class="col-sm-7 my-auto pl-5">
                            <h1 class="font-weight-light">
                                {% trans "Map your community" %}
                            </h1>

                            <p class="">
                                {% blocktrans %}
                                Make your voice heard! Fill out the form below and draw a map to add your community to Representable.org.
                                <br>
                                Follow the instructions in each section to get started.
                                {% endblocktrans %}
                            </p>
                            {% csrf_token %}
                        </div>
                        <div class="col-5 d-none d-sm-block">
                          <div id="mapping-image-div" class="m-auto py-4 w-75 h-100">
                            <object type="image/svg+xml" class="w-75 mx-auto d-block h-100" data="{% static 'img/mapping.svg' %}" alt="image of someone drawing a community map"></object>
                          </div>
                        </div>
                    </div>
                    <div class="row">
                      <!-- {# Include the non-field error fields #} -->
                      {% if comm_form.non_field_errors %}
                      <div class="non-field-errors form-error">
                          {% for err in comm_form.non_field_errors %}
                          <p class="form-error">{{ err }}</p>
                          {% endfor %}
                      </div>
                      {% endif %}
                      {% if comm_form.errors %}
                      <div id="django_form_errors">
                      </div>
                      {% endif %}
                      <div id="form_error" class="alert alert-danger alert-dismissible fade show form-error d-none" role="alert">
                          {% blocktrans %}There was an error in submitting your community. Please check over and
                          ensure that you have filled out all required fields. {% endblocktrans %}
                          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                          </button>
                      </div>
                    </div> {% endcomment %}
                    
                    <div id="entry_address" class="">
                        {% include './entry_address.html' %}
                    </div>

                    <div id="entry_survey" class="d-none">{% include './entry_survey.html' %}</div>

                    <div id="entry_map" class="d-none">{% include './entry_map.html' %}</div>

                    <div id="entry_privacy" class="d-none">{% include './entry_privacy.html' %}</div>

                    </div>
                    <div class="row row-equal-cols">
                        <!-- Map -->
                        <div class="col-lg m-2">
                            <div class="collapse-card card-section">
                                <div class="card">
                                    <div class="card-header text-header-card">
                                        <strong>
                                        {% trans "4. Draw Your Community" %}
                                        </strong>
                                    </div>
                                    <div id='map-card' class="card-body">
                                        <!-- {# Include form.entry_polygon error. } -->
                                            <div id="map-error-alerts">
                                                {% if comm_form.user_polygon.errors %}
                                                <script>
                                                    sessionStorage.setItem("allChecks", "fail");
                                                </script>
                                                <div id="polygon_missing" class="alert alert-danger django-alert alert-dismissible fade show form-error" role="alert">
                                                  {% trans "You need to draw a community to submit the form." %}
                                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <strong>
                                                    {% trans "Search for a location, such as address, city, or zipcode to begin drawing your community." %}
                                                    <small class="text-danger">{% trans "(Required)" %}</small>
                                            </strong>
                                            <span class="float-right my-2">
                                                <button class="btn btn-secondary btn-sm mb-2 mr-2 d-none" id="shepherd-btn" onclick="myTour.start()" type="button">{% trans "Step-by-step guide" %}</button>
                                                <button class="btn btn-secondary btn-sm mb-2" onclick="showVideoPopup()" type="button">{% trans "Video Tutorial" %}</button>
                                            </span>
                                            <div id="geocoder" class="geocoder my-3"></div>
                                            <div class="map-bounding-box my-2 collapse">
                                                <p>{% blocktrans %} Draw your community by selecting <a href="https://www.census.gov/programs-surveys/geography/about/glossary.html#par_textimage_4" target="_blank" data-toggle="tooltip" title="The units you are selecting to draw your community are census block groups. Map drawers use these units when creating districts.">units</a> on the map.
                                                   Make sure that all your community is contained within the highlighted units, and that your drawn community does not contain gaps.
                                                   {% endblocktrans %}
                                                </p>
                                                <div class="map-box">
                                                    <div id='menu'></div>
                                                    <div id='map' class='draw_polygon_map' onload="map.resize()">
                                                      <div id="warning-box-id" class="map-popup-box warning-box">
                                                      </div>
                                                    </div>
                                                </div>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row row-equal-cols">
                        <!-- Map -->
                        <div class="col-lg m-2">
                            <div class="collapse-card card-section">
                                <div id="terms-card" class="card">
                                    <div class="card-header text-header-card">
                                        <strong>
                                        {% trans "5. Privacy and Terms of Use" %}
                                        </strong>
                                        <input class="btn btn-secondary float-right button-edit" type="button" value="Edit Section">
                                    </div>
                                    <div class="card-body collapse show">
                                        <p class="card-text">
                                            {% blocktrans %}Your privacy is our highest priority. We gather your identifying information to verify
                                            that you are a real person. We will not publicly share anyone's individual personal information,
                                            such as name, address, or email. {% endblocktrans %}
                                            {% if has_drive %}
                                            <br>
                                            We will only share your information with the organizers of {{organization_name}} because you are adding the community through their community mapping drive.
                                            {% endif %}
                                        </p>
                                        <div class="toc-check">
                                            <input class="toc-check-input" type="checkbox" value="" id="toc_check" required>
                                            <label class="toc-check-label" for="toc_check">
                                                {% url 'main:privacy' as url1%}
                                                {% url 'main:terms' as url2%}

                                                {% blocktrans %} Click here to indicate that you have read and agree to the
                                                <a target="_blank" rel="noopener noreferrer" href={{url2}}>Terms of Use</a> and
                                                <a target="_blank" rel="noopener noreferrer" href="{{url1}}">Privacy Policy</a>.
                                                <small class="text-danger">(Required)</small>
                                                {% endblocktrans %}
                                            </label>
                                        </div>
                                        <hr>
                                        {% blocktrans %} Any saved communities are final. In order to edit a saved community you will need
                                        to create a new community and delete the old one. {% endblocktrans %}

                                        <div class="row">
                                            <div class="col text-center"><div class="g-recaptcha" data-sitekey="{{recaptcha_public}}"></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dropuphelp2" class="btn-floating btn-group shadow-lg dropup">
                    <button type="button" class="btn fixed-action-btn btn-secondary shadow-lg dropdown-toggle" id="dropuphelp" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-question-circle" aria-hidden="true"></i><span class="d-none d-sm-inline"> {% trans "Help" %}</span>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropuphelp">
                    <a class="dropdown-item" href="https://docs.google.com/forms/d/e/1FAIpQLSfeyoZ87pS67iTh2c3t5031XqoNFNAdwF6Pt1NUns_z_Myxaw/viewform"> {% trans "Report Error/Send Feedback" %}</a>
                    </div>
                </div>
                <div class="btn-floating btn-group shadow-lg">
                    <button type="button" class="btn fixed-action-btn btn-secondary shadow-lg" id="loading-entry">
                    <div class="loader loader-small text-center"></div><span class="d-none d-sm-inline"> {% trans "Saving Community..." %}</span>
                    </button>
                </div>
                    <div class='row row-equal-cols'>
                        <div class='col-lg text-center m-2'>
                            <div style="display: inline-block;">
                                <button id="save" form="entryForm" type="submit" class="btn btn-lg btn-primary" value="Submit">{% trans "Save Community" %}</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-sm-2">
        </div>
        <div class="row">
            <div id="video_popup" class="card shadow col-sm-4 col-md-4 col-lg-4 d-none">
                <div id="video_popup_body" class="card-body">
                    <h5 class="card-title">
                        Video Tutorial <button type="button" class="close" onclick="closePopup()">&times;</button>
                    </h5>
                    <div class="embed-responsive embed-responsive-16by9">
                        <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/aQ4PhsxYGUE" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            </div>
    </div>

    {% endblock %}
    {% block script %}
    {{ form.media.js }}
    <script type="text/javascript">
        mapboxgl.accessToken = "{{ mapbox_key }}";
    </script>
    <script type="text/javascript" src="{% static 'main/js/components/keys.js' %}"></script>
    <script type="text/javascript" src="{% static 'main/js/components/states.js' %}"></script>
    <script type="text/javascript" src="{% static 'main/js/wicket.js' %}"></script>
    <script type="text/javascript" src="{% static 'main/js/geo.js' %}"></script>
    <script type="text/javascript">
        // Entry page
        mixpanel.track_links(".dropdown-user-guide", "User Guide Link Pressed (Entry Help Dropdown)");
        mixpanel.track_links(".dropdown-send-feedback", "Send Feedback Link Pressed (Entry Help Dropdown)");

        document.getElementById("dropuphelp").addEventListener("click",
            function(){
                mixpanel.track("Dropup Help Button Pressed (Entry Page)");
            }
        );

        mixpanel.track_forms("#entryForm", "Entry Form Submitted", {
            "drive_id": drive_id,
            "drive_name": drive_name,
            "organization_id": organization_id,
            "organization_name": organization_name,
        });

    </script>
    <script type="text/javascript">
    function validateRecaptcha() {
        var response = grecaptcha.getResponse();
        if (response.length === 0 && "{{ check_captcha }}" === "True") {
            let newAlert = document.createElement("div");
            newAlert.innerHTML =
              '<div id="' +
              "captcha_submit" +
              '" class="alert alert-danger alert-dismissible fade show map-alert" role="alert">\
            ' +
              "You must complete the captcha to submit this map" +
              '\
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">\
            <span aria-hidden="true">&times;</span>\
            </button>\
            </div>';
            document.getElementById("captcha").appendChild(newAlert);
            return false;
        } else {
            return formValidation();
        }
    }
    </script>
    <!-- Turf to get the bounding box. -->
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    {% endblock %}
