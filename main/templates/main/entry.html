{% extends 'main/base.html' %}
{% load leaflet_tags %}
{% load static %}
{% load widget_tweaks %}

{% block head %}
{{ form.media.css }}
{% leaflet_js %}
{% leaflet_css %}

<!-- https://docs.mapbox.com/mapbox-gl-js/example/mapbox-gl-draw/ -->
<!--  Mapbox GL JS-->
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<!--  GeoCoder -->
<meta name='robots' content='noindex, nofollow'>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.css' type='text/css' />
<!--  Polygon Draw-->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
<!--  Turf JS for calculating the area. -->
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>

<!--  Mapbox Draw -->
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css' />

<!--  Custom CSS -->
<link rel="stylesheet" href="{% static 'main/css/style.css' %}">
{% endblock %}

{% block content %}
<div class="row row-content">
    <div class="col">
        <h2 class="text-primary"> Draw your community! </h2>
        <p class="p-about"> Representable helps fight against gerrymandering by empowering communities
            to represent themselves more easily. Fill out the form below to
            add your community. </p>
    </div>
    <div class="col-sm-12">
        <!-- START FORM BODY -->
        <div class="row mt-3">
            <!-- Entry Form -->
            <form id="entryForm" method="post">
                <!-- First Row: Includes Map. -->
                <div class="row row-equal-cols">
                    <!-- Map -->
                    <div class="col-lg-8 mt-3">
                        <div class="card">
                            <div class="card-header text-header-card">
                                <strong>1. What does your community look like?</strong>
                            </div>
                            <div id='map-card' class="card-body">
                                <!-- {# Include form.entry_polygon error. } -->
                                <div id="map-error-alerts">
                                    {% if form.user_polygon.errors %}
                                    <div id="polygon_missing" class="alert alert-warning alert-dismissible fade show" role="alert">
                                        You need to draw a polygon to submit the form.
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                <div id='menu'>
                                </div>
                                <div id='map' class='draw_polygon_map'>
                                </div>
                                <div>
                                </div>
                                <p class="card-text"></p>
                                <h5>How big is your community?</h5>
                                <p> The numbers below show how big your community is in relation to
                                    the size of an average electoral district. Generally, a higher percentage
                                    indicates that your community has a bigger impact on election results in your district.
                                    <small class="text-info-custom"> Note that districts vary in size from state to state. </small>
                                </p>


                                <p class="card-text">Percent of State Lower Legislation Average District Size:</p>
                                <div class="progress">
                                    <div class="bar-step">
                                        <div class="label-line"></div>
                                    </div>
                                    <div id="pop" class="progress-bar progress-bar-striped" role="progressbar" aria-valuemin="0">
                                    </div>
                                </div>

                                <p class="card-text">Percent of State Upper Legislation Average District Size:</p>
                                <div class="progress">
                                    <div class="bar-step">
                                        <div class="label-line"></div>
                                    </div>
                                    <div id="popU" class="progress-bar" role="progressbar" aria-valuemin="0">
                                    </div>
                                </div>

                                <p class="card-text">Percent of State Congressional Average District Size:</p>
                                <div class="progress">
                                    <div class="bar-step">
                                        <div class="label-percent" id="ideal-pop"></div>
                                        <div class="label-line"></div>
                                    </div>
                                    <div id="popC" class="progress-bar" role="progressbar" aria-valuemin="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mt-3">
                        <div class="card mb-3">
                            <div class="card-header text-info-custom">
                                <b>Why should I draw my community?</b>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Drawing your community enables officials to draw fair district lines that allow you to be well-represented in your state legislature and congress.
                                </p>
                            </div>
                        </div>
                        <div class="card mb-3">
                            <div class="card-header text-info-custom">
                                <b>How do I draw my community?</b>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    1. Search for your location using the search bar!
                                    <hr>
                                    </hr>
                                    2. Press on <b> Draw Polygon </b> and draw a shape that includes everything you consider to be part of your community.
                                    <hr>
                                    </hr>
                                    This shape can include schools, watersheds, parks, administrative
                                    buildings, commercial centers, etc.
                                    <hr>
                                    </hr>
                                    3. Don't worry about making a mistake! You can always start again. Just press on <b> Delete Polygon </b> and again on <b> Draw Polygon </b>.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <hr> -->
                <div class="row row-equal-cols">
                    <div class="col-lg-8  mt-3">
                        <div class="card">
                            <div class="card-header text-header-card">
                                <strong>2. What does your community care about?</strong>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Include issues and demographic information about your area.
                                </p>
                                {% csrf_token %}
                                <!-- {# Include the non-field error fields #} -->
                                {% if form.non_field_errors %}
                                <div class="non-field-errors">
                                    {% for err in form.non_field_errors %}
                                    <p class="form-error">{{ err }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div id="main_community_form" class="form-group">
                                    <!-- {# Include the hidden fields #} -->
                                    {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                    {% endfor %}
                                    <!-- Include Formset -->
                                    {{ issue_formset.management_form }}
                                    <!-- {# Include the formset.} -->
                                    {% for hidden_issue_field in issue_formset.hidden_fields %}
                                    {{ hidden_issue_field }}
                                    {% endfor %}

                                    {{ issue_formset.non_field_errors }}
                                    <!-- Formset Row Non Field Errors -->
                                    <!-- KEEP THESE. Not useful now but may become useful in the future and this can save time. -->
                                    <!---------------------------------------------------------------------------->
                                    <!-- {% for formset_row in issue_formset %}
                                        {% if formset_row.non_field_errors %}
                                        {% for non_field_error in formset_row.non_field_errors %}
                                        <div id="formset_row_error" class="alert alert-warning" role="alert">
                                            {{ non_field_error }}
                                        </div>
                                        {% endfor %}
                                        {% endif %}
                                        {% endfor %} -->
                                    <!---------------------------------------------------------------------------->
                                    <!-- Begin formset container. -->
                                    <div id="formset_container">
                                        {% for formset_row in issue_formset %}
                                        <div class="row form-row issues_formset mt-2">
                                            <div class="col-sm-5 mt-2">
                                                {{ formset_row.category|append_attr:"class:form-control" }}
                                                <!-- Error Codes Here -->
                                                {% if formset_row.category.errors %}
                                                {% for error in formset_row.category.errors %}
                                                <small id="category_warning" class="text-danger">{{ error|escape }}</small>
                                                {% endfor %}
                                                {% endif %}
                                            </div>
                                            <div class="col-sm-5 mt-2">
                                                {{ formset_row.description|append_attr:"class:form-control" }}
                                                <!-- Error Codes Here -->
                                                {% if formset_row.description.errors %}
                                                {% for error in formset_row.description.errors %}
                                                <small id="category_warning" class="text-danger">{{ error|escape }}</small>
                                                {% endfor %}
                                                {% endif %}
                                            </div>
                                            <div class="col-sm-2 mt-2">
                                                <button name="removeFormRow" class="btn btn-outline-danger remove-form-row">Remove</button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <!-- End formset container. -->
                                    <div class="row mt-3">
                                        <div class='col-sm-12'>
                                            <button name="addFormRow" class="btn btn-outline-success add-form-row">Add New Issue</button>
                                            <small> You can add maximum 10 issues. </small>
                                            <!-- 10 is arbitrary for now. Check forms.py -->
                                        </div>
                                    </div>
                                    <!-- {# Tags Field} -->
                                    <div class="field-wrap mt-3">
                                        {{ form.tags.label_tag }}
                                        <div class="form-error">
                                            {{ form.tags.errors }}
                                        </div>
                                        {{ form.tags|append_attr:"class:form-control" }}
                                        {% if form.tags.help_text %}
                                        <p class="help">{{ form.tags.help_text|safe }}</p>
                                        {% endif %}
                                    </div>


                                </div>

                                <!-- {# Is this your community? Field} -->
                                <div class="field-wrap">
                                    <div class="form-error">
                                        {{ form.my_community.label_tag }} <small class="text-danger">(Required)</small>
                                        {% if form.my_community.errors %}
                                        <div>
                                            <div id="my_community_missing" class="alert alert-warning map-alert" role="alert">
                                                You need to specify if you are part of this community.
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {{ form.my_community|append_attr:"class:form-control" }}
                                    {% if form.my_community.help_text %}
                                    <p class="help">{{ form.my_community.help_text|safe }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 mt-3">
                        <div class="card mb-3">
                            <div class="card-header text-info-custom">
                                <b>Why do we need this information?</b>
                            </div>
                            <div class="card-body">
                                <p class="card-text" style="text-color:white;">
                                    Including information about your community
                                    <b>exposes gerrymandering</b>. The more information
                                    you provide, the easier it will be for officials
                                    and non-profits to draw fairer electoral districts.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class='row mt-4'>
                <div class='col'>
                    <button id="save" form="entryForm" type="submit" class="btn btn-primary" value="Submit">Submit Entry</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
{{ form.media.js }}
<script type="text/javascript">
    mapboxgl.accessToken = "{{ mapbox_key }}";
</script>
<script type="text/javascript" src="{% static 'main/js/wicket.js' %}"></script>
<script type="text/javascript" src="{% static 'main/js/geo.js' %}"></script>
<!-- Turf to get the bounding box. -->
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
{% endblock %}
